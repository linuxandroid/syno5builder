/* Copyright (c) 2014 Synology Inc. All rights reserved. */

Ext.namespace("SYNO.SDS.TaskRunner");SYNO.SDS._TaskMgr=function(n){var e=n||10,h=[],a=[],d=0,i=false,l=false,j=function(o,p){while(p!==0){w=o%p;o=p;p=w}return o},g=function(){var p,o,q=h[0].interval;for(p=1;(o=h[p]);p++){q=j(q,o.interval)}return Math.max(q,n)},f=function(){var o=g();if(o!==e){e=o;return true}return false},c=function(){i=false;clearTimeout(d);d=0},k=function(){if(!i){i=true;f();d=setTimeout(m,0)}},b=function(o){a.push(o);if(o.onStop){o.onStop.apply(o.scope||o)}},m=function(){var u,s,r,o,p,x=false,q=new Date().getTime();for(u=0;(s=a[u]);u++){h.remove(s);x=true}a=[];if(!h.length){c();return}for(u=0;(s=h[u]);++u){s=h[u];if(l&&s.preventHalt!==true){b(s);continue}o=q-s.taskRunTime;if(s.interval<=o){try{p=s.run.apply(s.scope||s,s.args||[++s.taskRunCount])}catch(v){SYNO.Debug("TaskRunner: task "+s.id+" exception: "+v);if(Ext.isDefined(SYNO.SDS.JSDebug)){s.taskRunTime=q;throw v}}s.taskRunTime=q;r=s.interval;s.interval=s.adaptiveInterval();if(r!==s.interval){x=true}if(p===false||s.taskRunCount===s.repeat){b(s);return}}if(s.duration&&s.duration<=(q-s.taskStartTime)){b(s)}}if(x){f()}d=setTimeout(arguments.callee,e)};this.start=function(p,o){var q=new Date().getTime();h.push(p);p.taskStartTime=q;p.taskRunTime=(false===o)?q:0;p.taskRunCount=0;if(!i){k()}else{f();clearTimeout(d);d=setTimeout(m,0)}return p};this.stop=function(o){b(o);return o};this.stopAll=function(){var p,o;c();for(p=0;(o=h[p]);p++){if(o.onStop){o.onStop()}}h=[];a=[]};this.setHalt=function(o){l=o}};SYNO.SDS.TaskMgr=new SYNO.SDS._TaskMgr(100);SYNO.SDS.TaskRunner=Ext.extend(Ext.util.Observable,{tasks:null,constructor:function(){SYNO.SDS.TaskRunner.superclass.constructor.apply(this,arguments);this.addEvents("add","remove","beforestart");this.tasks={}},destroy:function(){this.stopAll();this.tasks={};this.isDestroyed=true},start:function(b,a){if(this.isDestroyed){return}if(!b.running){this.fireEvent("beforestart",b);SYNO.SDS.TaskMgr.start(b,a)}b.running=true;return b},stop:function(a){if(a.running){SYNO.SDS.TaskMgr.stop(a)}a.running=false;return a},stopAll:function(){for(var a in this.tasks){if(!this.tasks[a].running){continue}SYNO.SDS.TaskMgr.stop(this.tasks[a])}},addTask:function(a){a.id=a.id||Ext.id();this.tasks[a.id]=a;this.fireEvent("add",a);return a},createTask:function(b){b.id=b.id||Ext.id();var a=this.tasks[b.id];if(a){a.apply(b)}else{a=new SYNO.SDS.TaskRunner.Task(b,this);this.addTask(a)}return a},createAjaxTask:function(b){b.id=b.id||Ext.id();var a=this.tasks[b.id];if(a){a.apply(b)}else{a=new SYNO.SDS.TaskRunner.AjaxTask(b,this);this.addTask(a)}return a},removeTask:function(b){var a=this.tasks[b];if(a){this.fireEvent("remove",a);delete this.tasks[b]}},getTask:function(a){return this.tasks[a]||null}});SYNO.SDS.TaskRunner.Task=Ext.extend(Ext.util.Observable,{INTERVAL_DEFAULT:60000,INTERVAL_FALLBACK:60000,manager:null,running:false,removed:false,taskFirstRunTime:0,constructor:function(a,b){SYNO.SDS.TaskRunner.Task.superclass.constructor.apply(this,arguments);this.manager=b;this.apply(a)},apply:function(a){this.applyInterval(a.interval);delete a.interval;this.applyConfig(a)},applyConfig:function(a){Ext.apply(this,a)},applyInterval:function(a){this.intervalData=a;if(!Ext.isFunction(this.intervalData)&&!Ext.isArray(this.intervalData)&&!Ext.isNumber(this.intervalData)){this.intervalData=this.INTERVAL_DEFAULT}this.interval=this.adaptiveInterval()},adaptiveInterval:function(){var c,b=0,d=this.intervalData,a=null;if(this.taskFirstRunTime){b=new Date().getTime()-this.taskFirstRunTime}if(Ext.isNumber(d)){a=d}else{if(Ext.isFunction(d)){a=d.call(this.scope||this,b)}else{if(Ext.isArray(d)){for(c=0;c<d.length;++c){if(d[c].time>b){break}a=d[c].interval}}}}if(!Ext.isNumber(a)){SYNO.Debug("TaskRunner: Task "+this.id+" interval fallback to "+this.INTERVAL_FALLBACK);a=this.INTERVAL_FALLBACK}return a},start:function(a){var b=new Date().getTime();if(this.removed){return}if(!this.taskFirstRunTime){this.taskFirstRunTime=(false===a)?b+this.interval:b}return this.manager.start(this,a)},stop:function(){if(this.removed){return}return this.manager.stop(this)},restart:function(a){this.stop();this.start(a)},remove:function(){this.stop();this.manager.removeTask(this.id);this.removed=true}});SYNO.SDS.TaskRunner.AjaxTask=Ext.extend(SYNO.SDS.TaskRunner.Task,{reqId:null,reqConfig:null,cbHandler:null,autoJsonDecode:false,single:false,constructor:function(a,b){SYNO.SDS.TaskRunner.AjaxTask.superclass.constructor.call(this,a,b)},applyConfig:function(a){Ext.apply(this,{run:this.run,scope:this});this.autoJsonDecode=(true===a.autoJsonDecode);this.single=(true===a.single);this.preventHalt=(true===a.preventHalt);this.cbHandler={};this.reqConfig={};Ext.copyTo(this.cbHandler,a,["scope","callback","success","failure"]);Ext.apply(this.reqConfig,a);Ext.apply(this.reqConfig,{success:null,failure:null,callback:this.onCallback,scope:this});Ext.applyIf(this.reqConfig,{method:"GET"});delete this.reqConfig.id;delete this.reqConfig.autoJsonDecode;delete this.reqConfig.single},stop:function(){if(this.reqId){Ext.Ajax.abort(this.reqId);this.reqId=null}SYNO.SDS.TaskRunner.AjaxTask.superclass.stop.apply(this,arguments)},run:function(){SYNO.SDS.TaskRunner.AjaxTask.superclass.stop.call(this);this.reqId=Ext.Ajax.request(this.reqConfig)},onCallback:function(d,g,b){var a=b,c=Ext.apply({},d);Ext.apply(c,{scope:this.cbHandler.scope,callback:this.cbHandler.callback,success:this.cbHandler.success,failure:this.cbHandler.failure});if(g&&this.autoJsonDecode){try{a=Ext.util.JSON.decode(b.responseText)}catch(f){a={success:false};g=false}}if(g&&c.success){c.success.call(c.scope,a,d)}else{if(!g&&c.failure){c.failure.call(c.scope,a,d)}}if(c.callback){c.callback.call(c.scope,d,g,a)}this.fireEvent("callback",d,g,a);if(g&&this.single){this.reqId=null;this.remove()}else{if(this.reqId){this.reqId=null;this.start(false)}}}});Ext.override(Ext.Component,{getTaskRunner:function(){if(!this.taskRunner){this.taskRunner=new SYNO.SDS.TaskRunner();this.addManagedComponent(this.taskRunner)}return this.taskRunner},addTask:function(a){return this.getTaskRunner().createTask(a)},addAjaxTask:function(a){return this.getTaskRunner().createAjaxTask(a)},getTask:function(a){if(!this.taskRunner){return null}return this.taskRunner.getTask(a)},removeTask:function(b){var a=this.getTask(b);if(a){a.remove()}return a},addManagedComponent:function(a){this.components=this.components||[];this.components.push(a);return a},removeManagedComponent:function(a){this.components=this.components||[];this.components.remove(a);return a},beforeDestroy:function(){this.taskRunner=null;this.components=this.components||[];for(var a=0;a<this.components.length;++a){try{this.components[a].destroy()}catch(b){if(Ext.isDefined(SYNO.SDS.JSDebug)){SYNO.Debug(this.id+" sub-components["+a+"] destroy failed.");SYNO.Debug(this.components[a]);throw b}}}delete this.components}});Ext.override(Ext.form.TextField,{onRender:function(d,a){if(!this.withCssFrame){Ext.form.TextField.superclass.onRender.apply(this,[d,a]);return}var e=d.createChild({tag:"table",html:'<tbody><tr><td class="textfield-left"></td><td class="textfield-center"></td><td class="textfield-right"></td></tr></tbody>'});var c=e.query(".textfield-center");var b=new Ext.Element(c[0]);Ext.form.TextField.superclass.onRender.apply(this,[b,a])}});